{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "13165699665798160630"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "resourcePrefix": {
      "type": "string",
      "defaultValue": "geo",
      "minLength": 2,
      "maxLength": 3,
      "metadata": {
        "description": "Three-letter prefix used for resource naming (alphanumeric only)."
      }
    },
    "resourceToken": {
      "type": "string",
      "minLength": 5,
      "maxLength": 5,
      "metadata": {
        "description": "Five-character token appended to every resource name to ensure uniqueness."
      }
    },
    "containerImageRepository": {
      "type": "string",
      "defaultValue": "geolocation",
      "metadata": {
        "description": "Docker image repository name stored in Azure Container Registry."
      }
    },
    "containerImageTag": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Docker image tag to deploy from Azure Container Registry."
      }
    },
    "containerPort": {
      "type": "int",
      "defaultValue": 8080,
      "metadata": {
        "description": "Container port exposed by the application image."
      }
    },
    "acrSku": {
      "type": "string",
      "defaultValue": "Basic",
      "allowedValues": [
        "Basic",
        "Standard",
        "Premium"
      ],
      "metadata": {
        "description": "Container Registry SKU. Basic is sufficient for CI/CD scenarios."
      }
    },
    "appServiceSkuName": {
      "type": "string",
      "defaultValue": "S1",
      "metadata": {
        "description": "App Service plan SKU (Linux). Ensure the selected tier supports your scale requirements."
      }
    },
    "appServiceSkuTier": {
      "type": "string",
      "defaultValue": "Standard",
      "metadata": {
        "description": "App Service plan tier (Linux)."
      }
    },
    "enableKeyVault": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Provision Azure Key Vault for secret management."
      }
    },
    "enablePostgres": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Provision Azure Database for PostgreSQL Flexible Server for production database workloads."
      }
    },
    "postgresAdminUser": {
      "type": "string",
      "defaultValue": "pgadmin",
      "metadata": {
        "description": "PostgreSQL administrator login name (required when enablePostgres = true)."
      }
    },
    "postgresAdminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "PostgreSQL administrator password (override before deploying to production)."
      }
    },
    "postgresVersion": {
      "type": "string",
      "defaultValue": "16",
      "allowedValues": [
        "15",
        "16"
      ],
      "metadata": {
        "description": "PostgreSQL version to deploy when enablePostgres = true."
      }
    },
    "postgresSkuName": {
      "type": "string",
      "defaultValue": "Standard_B1ms",
      "allowedValues": [
        "Standard_B1ms",
        "Standard_B2s",
        "Standard_D2s_v3"
      ],
      "metadata": {
        "description": "Compute SKU for the PostgreSQL Flexible Server."
      }
    },
    "postgresStorageSizeGB": {
      "type": "int",
      "defaultValue": 64,
      "minValue": 32,
      "maxValue": 1024,
      "metadata": {
        "description": "Storage size (GB) for PostgreSQL Flexible Server."
      }
    },
    "databaseConnectionString": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Optional connection string that will be surfaced as an application setting when Key Vault is disabled."
      }
    },
    "googleMapsApiKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Optional Google Maps API key surfaced as an application setting when Key Vault is disabled."
      }
    }
  },
  "variables": {
    "nameSeed": "[toLower(format('{0}{1}', parameters('resourcePrefix'), parameters('resourceToken')))]",
    "acrName": "[toLower(format('{0}acr01', variables('nameSeed')))]",
    "appServicePlanName": "[toLower(format('{0}asp01', variables('nameSeed')))]",
    "webAppName": "[toLower(format('{0}app01', variables('nameSeed')))]",
    "logAnalyticsName": "[toLower(format('{0}law01', variables('nameSeed')))]",
    "appInsightsName": "[toLower(format('{0}ai01', variables('nameSeed')))]",
    "keyVaultName": "[toLower(format('{0}kv01', variables('nameSeed')))]",
    "postgresServerName": "[toLower(format('{0}pg01', variables('nameSeed')))]",
    "keyVaultDatabaseSecretName": "database-url",
    "keyVaultMapsSecretName": "google-maps-api-key",
    "keyVaultDnsSuffix": "[environment().suffixes.keyvaultDns]",
    "databaseSecretUri": "[if(parameters('enableKeyVault'), format('https://{0}.{1}/secrets/{2}', variables('keyVaultName'), variables('keyVaultDnsSuffix'), variables('keyVaultDatabaseSecretName')), '')]",
    "mapsSecretUri": "[if(parameters('enableKeyVault'), format('https://{0}.{1}/secrets/{2}', variables('keyVaultName'), variables('keyVaultDnsSuffix'), variables('keyVaultMapsSecretName')), '')]",
    "secretsAppSettings": "[if(parameters('enableKeyVault'), concat(createArray(createObject('name', 'AZURE_KEY_VAULT_NAME', 'value', variables('keyVaultName'))), createArray(createObject('name', 'DATABASE_URL', 'value', format('@Microsoft.KeyVault(SecretUri={0})', variables('databaseSecretUri')))), createArray(createObject('name', 'GOOGLE_MAPS_API_KEY', 'value', format('@Microsoft.KeyVault(SecretUri={0})', variables('mapsSecretUri'))))), concat(if(greater(length(trim(parameters('databaseConnectionString'))), 0), createArray(createObject('name', 'DATABASE_URL', 'value', parameters('databaseConnectionString'))), createArray()), if(greater(length(trim(parameters('googleMapsApiKey'))), 0), createArray(createObject('name', 'GOOGLE_MAPS_API_KEY', 'value', parameters('googleMapsApiKey'))), createArray())))]"
  },
  "resources": [
    {
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-08-01-preview",
      "name": "[variables('acrName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('acrSku')]"
      },
      "properties": {
        "adminUserEnabled": false,
        "publicNetworkAccess": "Enabled",
        "policies": {
          "retentionPolicy": {
            "status": "Enabled",
            "days": 14
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30,
        "features": {
          "enableLogAccessUsingOnlyResourcePermissions": true
        }
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('appInsightsName')]",
      "location": "[parameters('location')]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "Flow_Type": "Bluefield",
        "Request_Source": "rest",
        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-12-01",
      "name": "[variables('appServicePlanName')]",
      "location": "[parameters('location')]",
      "kind": "linux",
      "sku": {
        "name": "[parameters('appServiceSkuName')]",
        "tier": "[parameters('appServiceSkuTier')]",
        "size": "[parameters('appServiceSkuName')]",
        "capacity": 1
      },
      "properties": {
        "reserved": true,
        "zoneRedundant": false,
        "maximumElasticWorkerCount": 1
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[variables('webAppName')]",
      "location": "[parameters('location')]",
      "kind": "app,linux,container",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "httpsOnly": true,
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "siteConfig": {
          "linuxFxVersion": "[format('DOCKER|{0}', format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-08-01-preview').loginServer, parameters('containerImageRepository'), parameters('containerImageTag')))]",
          "appSettings": "[concat(createArray(createObject('name', 'WEBSITES_PORT', 'value', string(parameters('containerPort'))), createObject('name', 'WEBSITES_ENABLE_APP_SERVICE_STORAGE', 'value', 'false'), createObject('name', 'DOCKER_ENABLE_CI', 'value', 'true'), createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString), createObject('name', 'RUST_LOG', 'value', 'info')), variables('secretsAppSettings'))]",
          "alwaysOn": true,
          "ftpsState": "Disabled",
          "vnetRouteAllEnabled": true,
          "http20Enabled": true,
          "minTlsVersion": "1.2",
          "healthCheckPath": "/api/health",
          "acrUseManagedIdentityCreds": true
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]",
        "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]",
        "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Web/sites/{0}', variables('webAppName'))]",
      "name": "[format('{0}-diagnostics', variables('webAppName'))]",
      "properties": {
        "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]",
        "logs": [
          {
            "category": "AppServiceHTTPLogs",
            "enabled": true
          },
          {
            "category": "AppServiceConsoleLogs",
            "enabled": true
          },
          {
            "category": "AppServiceAppLogs",
            "enabled": true
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]",
        "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', variables('acrName'))]",
      "name": "[guid(resourceId('Microsoft.Web/sites', variables('webAppName')), 'acrpull')]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2023-12-01', 'full').identity.principalId]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]",
        "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
      ]
    },
    {
      "condition": "[parameters('enableKeyVault')]",
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('location')]",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "sku": {
          "name": "standard",
          "family": "A"
        },
        "enableRbacAuthorization": true,
        "enabledForTemplateDeployment": true,
        "enabledForDiskEncryption": false,
        "enabledForDeployment": false,
        "softDeleteRetentionInDays": 90,
        "publicNetworkAccess": "Enabled",
        "networkAcls": {
          "defaultAction": "Allow",
          "bypass": "AzureServices"
        }
      }
    },
    {
      "condition": "[parameters('enableKeyVault')]",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), 'kv-secrets-user')]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2023-12-01', 'full').identity.principalId]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
      ]
    },
    {
      "condition": "[and(parameters('enableKeyVault'), greater(length(trim(parameters('databaseConnectionString'))), 0))]",
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), variables('keyVaultDatabaseSecretName'))]",
      "properties": {
        "value": "[parameters('databaseConnectionString')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "condition": "[and(parameters('enableKeyVault'), greater(length(trim(parameters('googleMapsApiKey'))), 0))]",
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), variables('keyVaultMapsSecretName'))]",
      "properties": {
        "value": "[parameters('googleMapsApiKey')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "condition": "[parameters('enablePostgres')]",
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2023-03-01-preview",
      "name": "[variables('postgresServerName')]",
      "location": "[parameters('location')]",
      "properties": {
        "version": "[parameters('postgresVersion')]",
        "administratorLogin": "[parameters('postgresAdminUser')]",
        "administratorLoginPassword": "[parameters('postgresAdminPassword')]",
        "storage": {
          "storageSizeGB": "[parameters('postgresStorageSizeGB')]"
        },
        "backup": {
          "backupRetentionDays": 7,
          "geoRedundantBackup": "Disabled"
        }
      },
      "sku": {
        "name": "[parameters('postgresSkuName')]",
        "tier": "Burstable"
      }
    },
    {
      "condition": "[parameters('enablePostgres')]",
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
      "apiVersion": "2023-03-01-preview",
      "name": "[format('{0}/{1}', variables('postgresServerName'), 'geolocation')]",
      "properties": {},
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
      ]
    }
  ],
  "outputs": {
    "containerRegistryLoginServer": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-08-01-preview').loginServer]"
    },
    "appServiceName": {
      "type": "string",
      "value": "[variables('webAppName')]"
    },
    "appServicePlan": {
      "type": "string",
      "value": "[variables('appServicePlanName')]"
    },
    "logAnalyticsWorkspace": {
      "type": "string",
      "value": "[variables('logAnalyticsName')]"
    },
    "applicationInsightsName": {
      "type": "string",
      "value": "[variables('appInsightsName')]"
    },
    "keyVaultProvisioned": {
      "type": "bool",
      "value": "[parameters('enableKeyVault')]"
    },
    "postgresProvisioned": {
      "type": "bool",
      "value": "[parameters('enablePostgres')]"
    }
  }
}